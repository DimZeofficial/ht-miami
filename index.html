<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hotline Miami</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0a0a0a;
      color: #e0e0e0;
      font-family: 'Courier New', monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: hidden;
    }
    #container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: 100%;
      max-width: 800px;
      padding: 20px;
    }
    h1 { font-size: 2rem; color: #ff3c3c; letter-spacing: 4px; text-transform: uppercase; }
    #canvas-wrapper {
      position: relative;
      width: 800px;
      height: 600px;
      background: #000;
      border: 2px solid #ff3c3c;
      display: none;
    }
    canvas#canvas {
      width: 800px;
      height: 600px;
      display: block;
      image-rendering: pixelated;
    }
    #launch-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      padding: 40px;
      border: 2px solid #333;
      background: #111;
      width: 500px;
    }
    #launch-screen p { font-size: 0.85rem; color: #888; text-align: center; line-height: 1.6; }
    #play-btn {
      background: #ff3c3c;
      color: #000;
      border: none;
      padding: 14px 48px;
      font-size: 1.1rem;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      letter-spacing: 3px;
      text-transform: uppercase;
      cursor: pointer;
      transition: background 0.15s;
    }
    #play-btn:hover { background: #ff6060; }
    #play-btn:disabled { background: #444; color: #888; cursor: not-allowed; }
    #status { font-size: 0.8rem; color: #ff3c3c; text-align: center; min-height: 20px; letter-spacing: 1px; }
    #progress-bar-wrap { width: 100%; height: 6px; background: #222; display: none; }
    #progress-bar { height: 100%; width: 0%; background: #ff3c3c; transition: width 0.2s; }
    #fullscreen-btn {
      background: transparent;
      color: #888;
      border: 1px solid #444;
      padding: 6px 16px;
      font-family: 'Courier New', monospace;
      font-size: 0.75rem;
      cursor: pointer;
      letter-spacing: 1px;
      display: none;
    }
    #fullscreen-btn:hover { border-color: #ff3c3c; color: #ff3c3c; }
    #warning { font-size: 0.7rem; color: #555; text-align: center; max-width: 500px; }
  </style>
</head>
<body>
  <div id="container">
    <h1>Hotline Miami</h1>
    <div id="launch-screen">
      <p>Running via Boxedwine in your browser.<br/>First load downloads ~40MB — please wait.</p>
      <div id="progress-bar-wrap"><div id="progress-bar"></div></div>
      <button id="play-btn" onclick="startGame()">&#9654; PLAY</button>
      <div id="status">Ready.</div>
    </div>
    <div id="canvas-wrapper">
      <canvas id="canvas" oncontextmenu="event.preventDefault()"></canvas>
    </div>
    <button id="fullscreen-btn" onclick="goFullscreen()">&#x26F6; FULLSCREEN</button>
    <p id="warning">Best played in Chrome or Firefox. Click the game to capture input. Escape releases the mouse.</p>
  </div>

  <script>
    var gameStarted = false;
    var zipDataGlobal = null;

    function setStatus(msg) {
      document.getElementById("status").textContent = msg;
    }

    function setProgress(pct) {
      document.getElementById("progress-bar-wrap").style.display = "block";
      document.getElementById("progress-bar").style.width = pct + "%";
    }

    function goFullscreen() {
      var wrapper = document.getElementById("canvas-wrapper");
      if (wrapper.requestFullscreen) wrapper.requestFullscreen();
      else if (wrapper.webkitRequestFullscreen) wrapper.webkitRequestFullscreen();
    }

    function startGame() {
      if (gameStarted) return;
      gameStarted = true;

      var btn = document.getElementById("play-btn");
      btn.disabled = true;
      btn.textContent = "Loading...";
      setStatus("Downloading game...");
      setProgress(5);

      fetch("https://ht-miami.67adam89.workers.dev/")
        .then(function(response) {
          var contentLength = response.headers.get("Content-Length");
          var reader = response.body.getReader();
          var received = 0;
          var chunks = [];

          function pump() {
            return reader.read().then(function(result) {
              if (result.done) {
                var zipData = new Uint8Array(received);
                var offset = 0;
                for (var i = 0; i < chunks.length; i++) {
                  zipData.set(chunks[i], offset);
                  offset += chunks[i].length;
                }
                zipDataGlobal = zipData;
                loadEngine();
                return;
              }
              chunks.push(result.value);
              received += result.value.length;
              if (contentLength) {
                var pct = Math.round((received / parseInt(contentLength)) * 60) + 5;
                setProgress(pct);
                setStatus("Downloading: " + (received / 1048576).toFixed(1) + " MB");
              }
              return pump();
            });
          }
          return pump();
        })
        .catch(function(err) {
          setStatus("ERROR fetching zip: " + err.message);
          document.getElementById("play-btn").disabled = false;
          document.getElementById("play-btn").textContent = "&#9654; PLAY";
          gameStarted = false;
        });
    }

    function loadEngine() {
      setStatus("Loading engine...");
      setProgress(70);

      window.Module = {
        canvas: document.getElementById("canvas"),
        arguments: ["C:/HotlineMiami.exe"],
        locateFile: function(path) { return "./" + path; },
        print:    function(text) { console.log("[bw]", text); },
        printErr: function(text) { console.warn("[bw err]", text); },
        setStatus: function(text) {},
        totalDependencies: 0,
        monitorRunDependencies: function(left) {},
        onRuntimeInitialized: function() {},

        preRun: [function() {
          // Pause execution until we finish extracting files
          Module.addRunDependency("extract-zip");

          setStatus("Extracting files...");
          setProgress(75);

  JSZip.loadAsync(zipDataGlobal).then(function(zip) {
  var files = [];
  zip.forEach(function(relativePath, entry) {
    if (!entry.dir) files.push({ path: relativePath, entry: entry });
  });

  // Pre-create base directories
  try { FS.mkdir("/libsdl"); } catch(e) {}
  try { FS.mkdir("/libsdl/Boxedwine"); } catch(e) {}
  try { FS.mkdir("/libsdl/Boxedwine/root"); } catch(e) {}
  try { FS.mkdir("/libsdl/Boxedwine/root/c"); } catch(e) {}

            var total = files.length;
            var done = 0;

            function processNext(index) {
              if (index >= files.length) {
                // All files written — resume Boxedwine
                Module.removeRunDependency("extract-zip");
                setStatus("Starting game...");
                setProgress(100);
                setTimeout(function() {
                  document.getElementById("launch-screen").style.display = "none";
                  document.getElementById("canvas-wrapper").style.display = "block";
                  document.getElementById("fullscreen-btn").style.display = "inline-block";
                  document.getElementById("canvas").focus();
                }, 300);
                return;
              }

              var f = files[index];
              f.entry.async("uint8array").then(function(data) {
                var cleanPath = f.path.replace(/^c\//, "");
                var dest = "/libsdl/Boxedwine/root/c/" + cleanPath;

                // Create parent directories
                var parts = dest.split("/");
                for (var i = 2; i < parts.length - 1; i++) {
                  var dir = parts.slice(0, i + 1).join("/");
                  try { FS.mkdir(dir); } catch(e) {}
                }

                FS.writeFile(dest, data);
                done++;
                setProgress(75 + Math.round((done / total) * 20));
                setStatus("Extracting: " + done + " / " + total + " files");
                processNext(index + 1);
              }).catch(function(err) {
                setStatus("ERROR on file " + f.path + ": " + err.message);
                console.error(err);
              });
            }

            processNext(0);

          }).catch(function(err) {
            setStatus("ERROR extracting zip: " + err.message);
            console.error(err);
          });
        }]
      };

      var script = document.createElement("script");
      script.src = "./boxedwine.js";
      script.onerror = function() { setStatus("ERROR: Could not load boxedwine.js"); };
      document.body.appendChild(script);
    }

    document.addEventListener("DOMContentLoaded", function() {
      var wrapper = document.getElementById("canvas-wrapper");
      if (wrapper) {
        wrapper.addEventListener("click", function() {
          document.getElementById("canvas").focus();
        });
      }
    });
  </script>
</body>
</html>
